<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Avoid IE compatibility mode, as it breaks layout -->

    <title>IP</title>

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-blue-grey.css">

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh"
      crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg.js"></script>
    <script src="overpass.js"></script>
    
  </head>

  <body>

  <svg id="svg" style="width: 1000px; height: 700px;"></svg>
  
  <script>
    var s = Snap("#svg");
  
    var wgs_bbox = [[52.40021943419403, 10.158920288085938], [52.423726814004645, 10.202608108520508]];
    var size = [$("#svg").width(), $("#svg").height()];
    
    var Projection = function(bbox, size) {
      this.projection = proj4("WGS84", "EPSG:3857");
      this.bbox=bbox;
      this.size=size;
      this.merc_bbox=[this.projection.forward(wgs_bbox[0]), this.projection.forward(wgs_bbox[1])];

      var scalefactor1=(this.merc_bbox[1][0]-this.merc_bbox[0][0])/this.size[1];
      var scalefactor2=(this.merc_bbox[1][1]-this.merc_bbox[0][1])/this.size[0];
      this.scale = (scalefactor1 > scalefactor2) ? scalefactor1 : scalefactor2;
    }
    
    Projection.prototype.convert = function(latlon) {
      var xy=this.projection.forward(latlon);
      var dxy=[(xy[0]-this.merc_bbox[0][0])/this.scale, (xy[1]-this.merc_bbox[0][1])/this.scale];
      dxy=[dxy[1], this.size[1]-dxy[0]]
      return dxy;
    }
    
    
    var projection = new Projection(wgs_bbox, size);
    
    
  
    var drawData1=function(data) {
      //loop over each element
      for (var key in data.ways) {
        if (data.ways.hasOwnProperty(key)) {
          var way=data.ways[key];
          var waypoints=[];
          way.nodes.forEach(function (nodeid, index) {
            var node=data.nodes[nodeid];
            var xy=projection.convert([node.lat, node.lon]);
            waypoints=waypoints.concat(xy);
          });
          
          var line=s.polyline(waypoints);
          line.attr({
            fill: "none",
            stroke: "#000000",
            strokeWidth: 5
          });
        }
      }
    }
    var drawData2=function(data) {
      //loop over each element
      for (var key in data.ways) {
        if (data.ways.hasOwnProperty(key)) {
          var way=data.ways[key];
          var waypoints=[];
          way.nodes.forEach(function (nodeid, index) {
            var node=data.nodes[nodeid];
            var xy=projection.convert([node.lat, node.lon]);
            waypoints=waypoints.concat(xy);
          });
          
          var line=s.polyline(waypoints);
          line.attr({
            fill: "none",
            stroke: "#ffffff",
            strokeWidth: 3
          });
        }
      }
    }

    var convertOsmData=function(osm_data) {
      var nodes={};
      var ways={};
      
      //loop over each element
      osm_data.elements.forEach(function(el, index) {
        if (el.type=="way") {
          ways[el.id]=el;
        }
        else if (el.type=="node") {
          nodes[el.id]=el;
        }
        else {
          console.log("Type " + el.type + " unsupported.");
        }
      });
      
      return { "ways": ways, "nodes": nodes };
      
    }

    // converting WGS84 (GPS) to EPSG:3857 (Web Mercator)
    
    overpass.query_streets(function(osm_data) {
          var data = convertOsmData(osm_data);
          drawData1(data);
          drawData2(data);          
      });

    
  


  </script>


  
  
  </body>
</html>
