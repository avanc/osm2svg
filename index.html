<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Avoid IE compatibility mode, as it breaks layout -->

    <title>Map</title>

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-blue-grey.css">

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh"
      crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.0.13/svg.js"></script>
    <script src="projection.js"></script>
    <script src="overpass.js"></script>
    <script src="testdata.json"></script>
    
  </head>

  <body>

  <div id="map" style="width: 1000px; height: 700px;"></div>
  
  <script>
    var draw;
    SVG.on(document, 'DOMContentLoaded', function() {
      draw = SVG().addTo('#map').size("100%", "100%");
      overpass.query_streets(function(osm_data) {
          var data = convertOsmData(osm_data);
          drawData(data);
      });
      
    })
    var wgs_bbox = [[52.40021943419403, 10.158920288085938], [52.423726814004645, 10.202608108520508]];
    var size = [$("#map").width(), $("#map").height()];
    
    var projection = new Projection(wgs_bbox, size);
    
    var drawWay=function(way, nodes, style) {
      var waypoints=[];
      way.nodes.forEach(function (nodeid, index) {
        var node=nodes[nodeid];
        var xy=projection.convert([node.lat, node.lon]);
        waypoints=waypoints.concat(xy);
      });
      
      var line=draw.polyline(waypoints);
      line.attr(style);
    }
    
    var rules = [
      {
        "name": "tertiary",
        "filter": function(tags){
          return (tags.hasOwnProperty("highway") && tags.highway=="tertiary");        
        },
        "cycles": {
          "streets_bg": {
            fill: "none",
            stroke: "#cbcb8e",
            "stroke-width": 7
          },
          "streets_fg": {
            fill: "none",
            stroke: "#FEFEB2",
            "stroke-width": 5
          }
        }
      },
      {
        "name": "residential",
        "filter": function(tags){
          return (tags.hasOwnProperty("highway") && tags.highway=="residential");        
        },
        "cycles": {
          "streets_bg": {
            fill: "none",
            stroke: "#aaaaaa",
            "stroke-width": 5
          },
          "streets_fg": {
            fill: "none",
            stroke: "#ffffff",
            "stroke-width": 3
          }
        }
      },
      {
        "name": "cycleway",
        "filter": function(tags){
          return (tags.hasOwnProperty("highway") && tags.highway=="cycleway");        
        },
        "cycles": {
          "streets_bg": {
            fill: "none",
            stroke: "#ffffff",
            "stroke-width": 3,
            opacity: 0.3
          },
          "streets_fg": {
            fill: "none",
            stroke: "#F68474",
            "stroke-width": 2,
            "stroke-dasharray":"5,5"
          }
        }
      },

    ]
    
    var cycles = ["streets_bg", "streets_fg"];
    
    var drawData=function(data) {
      cycles.forEach(function(cycle, index) {
        rules.forEach(function(rule, index) {
          if (rule.cycles.hasOwnProperty(cycle)) {

            for (var key in data.ways) {
              if (data.ways.hasOwnProperty(key)) {
                var way=data.ways[key];
                if (rule.filter(way.tags)) {
                  drawWay(way, data.nodes, rule.cycles[cycle]);
                }
              }
            }
          }
        });
      });
    }

    var convertOsmData=function(osm_data) {
      var nodes={};
      var ways={};
      
      //loop over each element
      osm_data.elements.forEach(function(el, index) {
        if (el.type=="way") {
          ways[el.id]=el;
        }
        else if (el.type=="node") {
          nodes[el.id]=el;
        }
        else {
          console.log("Type " + el.type + " unsupported.");
        }
      });
      
      return { "ways": ways, "nodes": nodes };
      
    }

    
  


  </script>


  
  
  </body>
</html>
